<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
    <script>
     var hawbRowIndexgs = <?!= JSON.stringify(data) ?>;
    </script>
 <title>Hawb Entry</title>
 <style>
   td {
     padding: 5px;
     border: 1px solid grey;
   }
   .alertdate, .pdate, .ddate, #pdatedisp, #ddatedisp {
     width: 130px;
   }
   .asses {
    width: 15px;
   }
   .times{
     margin-top: 3px;
     width: 65px;
     margin-right: 3px;
   }
   #delaci, #puaci, #wtime, #shipmethod, #ponbydisp, #donbydisp {
    width: 30px;
    margin-left: 5px;
   }
   #shipmethod {
    width: 50px;
    margin-left: 5px;
   }
   .hide {
     display: none;
   }

 </style>

</head>
<body>
  <div class="body">
    <div id="alert">
      <table>
        <tr><th>Select Alert Date</th><th>Alert Date</th><th>Alert Time</th><th>Ship Method</th></tr>
        <tr><td><input type="date" id="alertdate" onchange="selectChange(this.value, 'alertdt')"></td><td><input type="text" id="alertdt" value=""></td></td><td><input type="text" id="alerttime" value=""></td>
        <td><label for="shipmethod">Shipment Method</label><input type="text" name="shipmethod" id = 'shipmethod' value="Ground">
          <select name="shipmethodsel" id="shipmethodsel"  onchange="selectChange(this.options[this.selectedIndex].value, 'shipmethod')">
            <option value="Ground">Select one</option>
            <option value="Ground">Ground</option>
            <option value="Air">Air</option>
            <option value="Ocean">Ocean</option>
         </select></td></tr>

      </table>
    <hr>
    </div>
    <div id="type" class="type">
      <table><tr><td>
      <label for="service">Service LEVEL</label>
      <select id="service" onchange="selectChange(this.options[this.selectedIndex].value, 'srvlevel')">
        <option value="">Select One</option>
        <option value="Economy">Economy</option>
        <option value="Economy(3Day)">Economy(3Day)</option>
        <option value="Same Day">Same Day</option>
        <option value="Standard">Standard</option>
        <option value="Standard(2Day)">Standard(2Day)</option>
        <option value="Overnight AM">Overnight AM</option>
        <option value="Overnight PM">Overnight PM</option>
        <option value="Deferred(4-5 days)">Deferred(4-5 days)</option>
        <option value="Other">Other</option>
      </select>
        <input type="text" id="srvlevel" value = "" readonly>
      </td>

    <td>
        <label for="type">Service TYPE</label>
        <select id="type" onchange="selectChange(this.options[this.selectedIndex].value, 'srvtype')">
          <option value="">Select One</option>
          <option value="P">Pickup</option>
          <option value="D">Delivery</option>
          <option value="X">Xfer</option>
          <option value="PD">Pickup & Delivery</option>
        </select>
        <input type="text" id="srvtype" value = "" readonly>
    </td>
    </tr>
    </table>
    <hr>
    </div>
    <div id="pddiv" >

      <table id="pddate" >
          <tr><th id="pdth" class= "hide">Pickup Date Time</th><th id="ddth" class= "hide">Delivery Date Time</th></tr>
          <tr>
        <div id="pdatediv" ><td id="pdtd" class= "hide"><input type="date" id="pdate" onchange="selectChange(this.value, 'pdatedisp')">
          <input type="text" id ="pdatedisp" >
          <input type="radio" name="puonby"  value="By" onchange="selectChange(this.value, 'ponbydisp')">By
          <input type="radio" name="puonby"  value="On" onchange="selectChange(this.value, 'ponbydisp')">On<input type="text" id="ponbydisp" value="">
          <br><input class="times" type="text" id="pfrom" value = ""> TO <input type="text" id="pto" class="times" value = ""><br>
          Pickup Zip:<input type="text" id= "puzip" class="times" value = "" onKeyup= "fillAci(this.value, 'puaci', 'pucity')" >City:<input type="text" id= "pucity" class="times" value = "">ACI:<input type="text" id="puaci" value = ""readonly></td></div>

          <div id="ddatediv" class= "hide"><td id="ddtd" class= "hide"><input type="date" id="ddate" onchange="selectChange(this.value, 'ddate')">
            <input type="text" id ="ddatedisp" value="">
            <input type="radio" name="delonby"  value="By" onchange="selectChange(this.value, 'donbydisp')">By
            <input type="radio" name="delonby"  value="On" onchange="selectChange(this.value, 'donbydisp')">On<input type="text" id="donbydisp" value="">

            <br><input type="text" class="times" id="dfrom" value = ""> TO <input type="text" id="dto" class="times" value = ""><br>
            Delivery Zip:<input type="text" id= "delzip" class="times" value = "" onKeyup= "fillAci(this.value, 'delaci', 'delcity')" >City:<input type="text" id= "delcity" class="times" value = "">ACI:<input type="text" id="delaci" value = ""readonly></td></div>

            <td>
              <label for="billwt">Billable WT: </label>
              <input type="text" id="billwt" name="billwt" class="times" value = "">
            </td>
        </tr>
      </table>
    </div>
    <hr>
    <div id="assesdiv">
      <table id="asses">
        <tr><th>Assessorials</th></tr>
        <tr>
          <td><input class='asses' type="checkbox" id="lg">Liftgate</td>
          <td><input class='asses' type="checkbox" id="spd">Special</td>
          <td><input class='asses' type="checkbox" id="ind">Inside</td>
          <td><input class='asses' type="checkbox" id="upk">UnPack</td>
          <td><input class='asses' type="checkbox" id="pac">Pack</td>
          <td><input class='asses' type="checkbox" id="2man">2 Man</td>
          <td><input class='asses' type="checkbox" id="wg">White Glove</td>
          <td><input class='asses' type="checkbox" id="jack">Pallet Jack</td>
        </tr></table>

        <table><tr>
            <td><input class='asses' type="checkbox" id="call" value = "">Call to Schedule</td>
            <td><input class='asses' type="checkbox" id="res" value = "">Residence</td>
            <td><input class='asses' type="checkbox" id="atm" value = "">Attempt</td>
            <td><label for="waittime">Select Wait Time</label><select name="waittime" id="waitime" onchange="selectChange(this.options[this.selectedIndex].value, 'wtime')">
                <option value="0">0</option>
                <option value="15">15</option><option value="30">30</option>
                <option value="45">45</option><option value="60">1 hr</option>
                <option value="75">75</option><option value="90">90</option>
                <option value="105">105</option><option value="120">2 hr</option>
                <option value="135">135</option><option value="150">150</option>
                <option value="165">165</option><option value="180">3 hr</option>
                <option value="195">195</option><option value="210">210</option>
                <option value="225">225</option><option value="240">4 hr</option>
                <option value="270">4hr 30m</option><option value="300">5hr</option>
                <option value="330">5hr 30m</option><option value="400">6hr</option>
              </select><input type="text" id= "wtime" value='0' value = "" readonly >Minutes</td>
            </tr>
        </table>
    </div>
    <hr>
      <div id="recoverydiv" class= "hide" >
        <label for="recoverysel">Choose Recover From</label>
        <select name="recoverysel" id="recoverysel"  onchange="selectChange(this.options[this.selectedIndex].value, 'recovery')">
          <option value="">Select One</option>
          <option value="Forward Air">Forward Air</option>
          <option value="Land Air">Land Air</option>
          <option value="American Line Haul">American Line Haul</option>
          <option value="JIT">JIT</option>
          <option value="Act2">ACT2</option>
          <option value="Sterling">Sterling</option>
          <option value="Southwest">Southwest</option>
          <option value="American Airlines">American Airlines</option>
          <option value="Delta">Delta</option>
          <option value="United">United</option>
        </select>
        <input type="text" id="recovery" value = "">
        <label for="recoverybill">Recovery Bill #</label>
        <input type="text" id="recoverybill" value = "">
        <hr>
      </div>
    <div id="dropdiv" class= "hide">
      <label for="dropsel">Choose Drop To</label>
      <select name="dropsel" id="dropsel"  onchange="selectChange(this.options[this.selectedIndex].value, 'drop')">
        <option value="">Select One</option>
        <option value="Forward Air">Forward Air</option>
        <option value="Land Air">Land Air</option>
        <option value="American Line Haul">American Line Haul</option>
        <option value="JIT">JIT</option>
        <option value="Act2">ACT2</option>
        <option value="Sterling">Sterling</option>
        <option value="Southwest">Southwest</option>
        <option value="American Airlines">American Airlines</option>
        <option value="Delta">Delta</option>
        <option value="United">United</option>
      </select>
      <input type="text" id="drop" value = "">
      <label for="dropbill">Drop Bill #</label>
      <input type="text" id="dropbill" value = "">
      <hr>
    </div>
  <div id="cartagediv">
    <label for="cartagesel">Cartage Contractor</label>
    <select name="cartagesel" id="cartagesel"  onchange="selectChange(this.options[this.selectedIndex].value, 'cartage')">
      <option value="">Select One</option>
      <option value="LAX">LAX lgl</option>
      <option value="Bella">Bella</option>
      <option value="Reserve">Reserve</option>
      <option value="AllTime">All Time</option>
      <option value="Metro">Metro</option>
      <option value="Ventura">Ventura Hwy</option>
      <option value="Orange">Orange Courier</option>
    </select>
    <label for="cartage">Contractor Routed To:</label>
    <input type="text" id="cartage" value = "">
  </div>
  <hr>
    <label for="xferto">Xfer To:</label>
    <input type="text" id="xferto" value = "">
  <hr>
    <div id="notesdiv">
      <textarea name="notes" id="notes" cols="100" rows="4" value = ""></textarea>
      <button onClick= "saveUpdate()" >Save Updates</button>
    </div>
  <hr>

  </div>
  <div>&copy Robert Lowell Brown 2018, 2019</div>

  <script>

          //create variable array to push to for spreadsheet update
    var sheetData = ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];
    var alertDate = ''
    var dDate = ''
    var pDate = ''
    var podDate = '' //set when loading form from sheet data for now
    var other = ''  //set when loading form from sheet data for now
    var row = "";
    // set text input form select change
    function selectChange(value, element) {
      document.getElementById(element).value = value;
      // based on value arrange form display
      if(value == "D"){
        showHide("ddtd", 'block');
        showHide("ddth", 'block');
        showHide("recoverydiv", 'block');
        showHide("pdtd", 'none');
        showHide("pdth", 'none');
        showHide("dropdiv", 'none');
      }else if(value == "P") {
        showHide("ddtd", 'none');
        showHide("ddth", 'none');
        showHide("recoverydiv", 'none');
        showHide("pdtd", 'block');
        showHide("pdth", 'block');
        showHide("dropdiv", 'block');
      }else if(value == "PD" || value == "X" ) {
        showHide("ddtd", 'block');
        showHide("ddth", 'block');
        showHide("recoverydiv", 'block');
        showHide("pdtd", 'block');
        showHide("pdth", 'block');
        showHide("dropdiv", 'block');
      }
    }

    function fillAci(zipEntry, idAci, idCity) {
      // takes zipcoade typed in looks for match then returns ACI code from match or N/A
      if(zipEntry.length >4) {
      var aciCode = "n/a";
      getZip(zipEntry, function(zipArray){
        aciCode = zipArray.acilax;
        zipCity = zipArray.city;
        document.getElementById(idAci).value = aciCode;
        document.getElementById(idCity).value = zipCity;
      })
      }
    }

    function showHide(id, displayType) {
      var e = document.getElementById(id);
      e.style.display = displayType;
    }

    function dateChange(value, element) {
      if(element == 'alertdate'){ alertDate = value.toSting(); }
      if(element == 'pdate'){ pDate = value.toSting(); }
      if(element == 'ddate'){ dDate = value.toSting(); }
    }

    window.onload = function() {
      loadValues();
      // set row array number to update from sheetData
      row = hawbRowIndexgs.rowIndex[0][0];

      function loadValues(){
        // get values from elements then push on array sheetData
        document.getElementById('alertdate').value = sqlDateFormat(hawbRowIndexgs.hawb[0][0].toString().slice(0,10));
        document.getElementById('alertdt').value = hawbRowIndexgs.hawb[0][0]
        document.getElementById('alerttime').value = hawbRowIndexgs.hawb[0][1];
        document.getElementById('srvlevel').value = hawbRowIndexgs.hawb[0][2];
        //sheetData[3] = hawbRowIndexgs.hawb[0][3]; // load hawb for later use on entry form
        document.getElementById('srvtype').value = hawbRowIndexgs.hawb[0][4];
        document.getElementById('delzip').value = hawbRowIndexgs.hawb[0][5];
        document.getElementById('delaci').value = hawbRowIndexgs.hawb[0][6];
        document.getElementById('puzip').value = hawbRowIndexgs.hawb[0][7];
        document.getElementById('puaci').value = hawbRowIndexgs.hawb[0][8];
        document.getElementById('billwt').value = hawbRowIndexgs.hawb[0][9];
        document.getElementById('wtime').value = hawbRowIndexgs.hawb[0][17];
        document.getElementById('pdate').value = sqlDateFormat(hawbRowIndexgs.hawb[0][22].toString().slice(0,10));
        document.getElementById('pdatedisp').value = hawbRowIndexgs.hawb[0][22].toString().slice(0,10);
        document.getElementById('pfrom').value = hawbRowIndexgs.hawb[0][23];
        document.getElementById('pto').value = hawbRowIndexgs.hawb[0][24];
        document.getElementById('ddatedisp').value = sqlDateFormat(hawbRowIndexgs.hawb[0][25].toString().slice(0,10));
        document.getElementById('ddatedisp').value = hawbRowIndexgs.hawb[0][25].toString().slice(0,10);
        document.getElementById('dfrom').value = hawbRowIndexgs.hawb[0][26];
        document.getElementById('dto').value = hawbRowIndexgs.hawb[0][27];
        document.getElementById('xferto').value = hawbRowIndexgs.hawb[0][38];
        document.getElementById('recovery').value = hawbRowIndexgs.hawb[0][32];
        document.getElementById('recoverybill').value = hawbRowIndexgs.hawb[0][33];
        document.getElementById('drop').value = hawbRowIndexgs.hawb[0][34];
        document.getElementById('dropbill').value = hawbRowIndexgs.hawb[0][35];
        document.getElementById('shipmethod').value =hawbRowIndexgs.hawb[0][36];
        document.getElementById('cartage').value = hawbRowIndexgs.hawb[0][37];
        document.getElementById('xferto').value = hawbRowIndexgs.hawb[0][38];
        document.getElementById('notes').value = hawbRowIndexgs.hawb[0][39];
        document.getElementById('delcity').value = hawbRowIndexgs.hawb[0][42];
        document.getElementById('pucity').value = hawbRowIndexgs.hawb[0][43] ;
        //console.log(hawbRowIndexgs.hawb[0][44])
        //console.log(hawbRowIndexgs.hawb[0][45])
        if(hawbRowIndexgs.hawb[0][44] != ""){document.getElementById('ponbydisp').value = hawbRowIndexgs.hawb[0][44] ;}
        if(hawbRowIndexgs.hawb[0][45] != ""){document.getElementById('donbydisp').value = hawbRowIndexgs.hawb[0][45] ;}
        if(hawbRowIndexgs.hawb[0][12] != "") {document.getElementById('spd').checked = true;}
        if(hawbRowIndexgs.hawb[0][13] != "") {document.getElementById('2man').checked = true;}
        if(hawbRowIndexgs.hawb[0][14] != "") {document.getElementById('lg').checked = true;}
        if(hawbRowIndexgs.hawb[0][15] != "") {document.getElementById('ind').checked = true;}
        if(hawbRowIndexgs.hawb[0][16] != "") {document.getElementById('atm').checked = true;}
        if(hawbRowIndexgs.hawb[0][18] != "") {document.getElementById('upk').checked = true;}
        if(hawbRowIndexgs.hawb[0][28] != "") {document.getElementById('pac').checked = true;}
        if(hawbRowIndexgs.hawb[0][29] != "") {document.getElementById('wg').checked = true;}
        if(hawbRowIndexgs.hawb[0][30] != "") {document.getElementById('call').checked = true;}
        if(hawbRowIndexgs.hawb[0][31] != "") {document.getElementById('res').checked = true;}
        if(hawbRowIndexgs.hawb[0][40] != "") {document.getElementById('jack').checked = true;}

        // set page up based on value in srvtype
        if(hawbRowIndexgs.hawb[0][4] == "D") { selectChange("D", "srvtype");
        }else if(hawbRowIndexgs.hawb[0][4] == "P") {selectChange("P", "srvtype");
        }else if(hawbRowIndexgs.hawb[0][4] == "X") { selectChange("X", "srvtype");
        }else if(hawbRowIndexgs.hawb[0][4] == "PD") { selectChange("PD", "srvtype");
        }
      }
    }

    function saveUpdate() {
        // manage sql update and then update sheet row
        buildPostBody(function(postBodyRtrn, row) {
          // take returned post body and send it to sendPost with url
          var url = "https://lgltrax.lglship.com/sheetdata/update"
          sendPost(url, postBodyRtrn, row)
        });

    }

    function updateSheet() {
      // send to spread sheet and update the row
      getValues(function(data, row){
        google.script.run.withSuccessHandler(onUpdate).updateSheet(data, row);
      })

    }

    function onUpdate(hawbArray) {
          //function to handle success of update
          google.script.host.close();
    }

    function getValues(callback){
        // load element with values from hawbRowIndexgs object Array

        sheetData[0] = document.getElementById('alertdt').value;
        sheetData[1] = document.getElementById('alerttime').value;
        sheetData[2] = document.getElementById('srvlevel').value;
        //sheetData[3] = ""
        sheetData[4] = document.getElementById('srvtype').value;
        sheetData[5] = document.getElementById('delzip').value;
        sheetData[6] = document.getElementById('delaci').value;
        sheetData[7] = document.getElementById('puzip').value;
        sheetData[8] = document.getElementById('puaci').value;
        sheetData[9] = document.getElementById('billwt').value;
        sheetData[10]= "";
        sheetData[11]= "";
        sheetData[17] = document.getElementById('wtime').value;
        sheetData[19]= "";
        sheetData[20]= "";
        if(sheetData[21] = document.getElementById('pdate').value.length >6) {
          sheetData[21] = document.getElementById('pdate').value}else {sheetData[21] =""}
        if(sheetData[22] = document.getElementById('pdate').value.length >6) {
          sheetData[22] = document.getElementById('pdate').value}
        sheetData[23] = document.getElementById('pfrom').value;
        sheetData[24] = document.getElementById('pto').value ;
        if(sheetData[25] = document.getElementById('ddate').value.length >6) {
          sheetData[25] = document.getElementById('ddate').value}
        sheetData[26] = document.getElementById('dfrom').value;
        sheetData[27] = document.getElementById('dto').value;
        sheetData[32] = document.getElementById('recovery').value;
        sheetData[33] = document.getElementById('recoverybill').value;
        sheetData[34] = document.getElementById('drop').value;
        sheetData[35] = document.getElementById('dropbill').value;
        sheetData[36] = document.getElementById('shipmethod').value;
        sheetData[37] = document.getElementById('cartage').value;
        sheetData[38] = document.getElementById('xferto').value;
        sheetData[39] = document.getElementById('notes').value;
        sheetData[42] = document.getElementById('delcity').value;
        sheetData[43] = document.getElementById('pucity').value;
        sheetData[44] = document.getElementById('ponbydisp').value;
        sheetData[45] = document.getElementById('donbydisp').value;

        if(document.getElementById('spd').checked) { sheetData[12] = 'spd';
        }else{sheetData[12] = "Delete"}
        if(document.getElementById('2man').checked) { sheetData[13] = '2man';
        }else{sheetData[13] = "Delete"}
        if(document.getElementById('lg').checked) {  sheetData[14] = 'lg';
        }else{sheetData[14] = "Delete"}
        if(document.getElementById('ind').checked) {  sheetData[15] = 'ind';
        }else{sheetData[15] = "Delete"}
        if(document.getElementById('atm').checked) { sheetData[16] = 'atm';
        }else{sheetData[16] = "Delete"}
        if(document.getElementById('upk').checked) {  sheetData[18] = 'upk';
        }else{sheetData[18] = "Delete"}
        if(document.getElementById('pac').checked) {  sheetData[28] = 'pac';
        }else{sheetData[28] = "Delete"}
        if(document.getElementById('wg').checked) {  sheetData[29] = 'wg';
        }else{sheetData[29] = "Delete"}
        if(document.getElementById('call').checked) { sheetData[30] = 'call';
        }else{sheetData[30] = "Delete"}
        if(document.getElementById('res').checked) { sheetData[31] = 'res';
        }else{sheetData[31] = "Delete"}
        if(document.getElementById('jack').checked) {  sheetData[40] = 'jack';
        }else{sheetData[31] = "Delete"}
        var row = hawbRowIndexgs.rowIndex[0][0]
        callback(sheetData, row);
      }

      function sqlDateFormat(strdate) {
        // take mm/dd/yyyy and make yyyy/mm/dd
        //console.log(strdate)
        var yyyy = strdate.slice(6,10);
        var mm = strdate.slice(0,2);
        var dd = strdate.slice(3,5);
        var sqlDate = yyyy + "-" + mm + "-" + dd
        //console.log(sqlDate)
        return sqlDate;
      }

      function buildPostBody(callback) {
        getValues(function(data, row){
          // send to SQL and Insert the row
          var h = data;
          //loop through h and replace Delete with ""
          for(x=0;x<h.length;x++) {
            if(h[x] == "Delete"){h[x] = ""};
          }
          //console.log(h)
          var postBody ={};
          postBody.A = h[0], postBody.B = h[1], postBody.C = h[2], postBody.D = h[3], postBody.E = h[4];
          postBody.F = h[5], postBody.G = h[6], postBody.H = h[7], postBody.I = h[8], postBody.J = h[9];
          postBody.K = h[10], postBody.L = h[11], postBody.M = h[12], postBody.N = h[13], postBody.O = h[14];
          postBody.P = h[15], postBody.Q = h[16], postBody.R = h[17], postBody.S = h[18], postBody.T = h[19];
          postBody.U = h[20], postBody.V = h[21], postBody.W = h[22], postBody.X = h[23], postBody.Y = h[24];
          postBody.Z = h[25], postBody.AA = h[26], postBody.AB = h[27], postBody.AC = h[28], postBody.AD = h[29];
          postBody.AE = h[30], postBody.AF = h[31], postBody.AG = h[32], postBody.AH = h[33], postBody.AI = h[34];
          postBody.AJ = h[35], postBody.AK = h[36], postBody.AL = h[37], postBody.AM = h[38], postBody.AN = h[39];
          postBody.AO = h[40], postBody.AP = h[41], postBody.AQ = h[42], postBody.AR = h[43], postBody.AT = h[44], postBody.AS1 = h[45];
          callback(postBody, row)

        })
      }

      function sendPost(url, body, row) {
            var http = new XMLHttpRequest();
            http.open("POST", url, true);
            http.setRequestHeader('Content-Type', 'application/json');
            http.send(JSON.stringify(body));
            http.onreadystatechange = function() {
              if(http.readyState == 4) {
               updateSheet();
              }
            }
       }

      function getZip(zip, callback) {
            var http = new XMLHttpRequest();
            var url = "https://lgltrax.lglship.com/aci/" + zip;
            http.open("GET", url, true);
            http.setRequestHeader('Content-Type', 'application/json');
            http.onreadystatechange = function() {
              if(http.readyState == 4) {
                var zipCodeArray = JSON.parse(http.responseText);
                callback(zipCodeArray[0]);
              }
            }
            http.send();
      }
  </script>
</body>
</html>
