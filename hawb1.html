<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>
      //var hawbsgs = <?!= JSON.stringify(data) ?>;

    </script>
    <style>
        .tab {
            display: inline-block;
            width: 50px;
            border: 1px solid black;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            padding: 5px;
            padding-left: 7px;
            background-color: lightskyblue;
        }
        .title {
            font-size: 2em;
            padding-left: 20px;
        }
        #divtabs {
            border: 1px solid, black;
        }

        .display {
           position: fixed;
           left: 0px;
        }

        .hidden {
            position: fixed;
            left: -290px;
        }
        .selected {
            background-color: lightgrey;
        }
        .hawbrow{
         width:100px;
         color: blue;
         text-decoration: underline;

        }
        .routeinp {
          display: inline-block;
          width: 90px;
        }
        .movable {
          display: inline-block;
        }
        td, th {
         border: 1px solid black;
         padding: 5px;
        }
        div {
         padding: 2px;
        }
        .bigred {
          background-color: hotpink;
        }
        .fakelink:hover {
          color:blue;
          transform: scale(1.15, 1.15);
          cursor: pointer;
        }
    </style>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
</head>
<body>
  <div>
    <div id="divtabs">
        <div id="header" class="title">LAX HAWB App</div>
        <div id="tab1" class="tab selected" onclick="tabClicked(1)" onmouseout= "askSave()" tabindex="-1">Home</div>
        <div id="tab2" class="tab" onclick="tabClicked(2)" onmouseout= "askSave()" tabindex="-1">Assesor</div>
        <div id="tab3" class="tab" onclick="tabClicked(3)" onmouseout= "askSave()" tabindex="-1">Routing</div>
        <div id="tab4" class="tab" onclick="tabClicked(4)" onmouseout= "askSave()" tabindex="-1">Costs</div>
    </div>
    <div id="divtab1" class="display">Hawb:
      <input id= 'hawbIn' type="text" class= "smallInput" onkeyup="findHawb()" onblur= "checkForUpdate()" >
      <div>&copy Robert Lowell Brown 2018, 2019</div>
      <div id = "divtab1_2"></div>
    </div>
    <div id="divtab2" class="hidden">Select

    </div>
    <div id="divtab3" class="hidden">
     <div id="routingform">

      <div id="cartagediv">
      <h3>Active HAWB: </h3>
      <label for="cartagesel">Cartage Contractor</label>
      <select name="cartagesel" id="cartagesel" onchange="selectChange(this.options[this.selectedIndex].value, 'cartage')" >
        <option value="">Select One</option>
        <option value="LAX">LAX lgl</option>
        <option value="Bella">Bella</option>
        <option value="Reserve">Reserve</option>
        <option value="AllTime">All Time</option>
        <option value="Metro">Metro</option>
        <option value="Ventura">Ventura Hwy</option>
        <option value="Orange">Orange Courier</option>
      </select>
      <hr>
      <label for="cartage" class="movable">Contractor Routed To:</label>
      <input type="text" id="cartage" class="routeinp" value = "">
      <hr>
      <label for="xferto" class="movable">Xfer To:</label>
      <input type="text" id="xferto" class="routeinp" value = "">
      <hr >
      <label for="recoverysel">Choose Recover From</label>
      <br>
      <select name="recoverysel" id="recoverysel"  onchange="selectChange(this.options[this.selectedIndex].value, 'recovery')">
      <option value="">Select One</option>
      <option value="Forward Air">Forward Air</option>
      <option value="Land Air">Land Air</option>
      <option value="American Line Haul">American Line Haul</option>
      <option value="JIT">JIT</option>
      <option value="Act2">ACT2</option>
      <option value="Sterling">Sterling</option>
      <option value="Southwest">Southwest</option>
      <option value="American Airlines">American Airlines</option>
      <option value="Delta">Delta</option>
      <option value="United">United</option>
      </select>
      <input type="text" id="recovery" class="routeinp" value = "">
      <br><label for="recoverybill" class="movable">Recovery Bill #</label>
      <input type="text" id="recoverybill" class="routeinp" value = "">
      <hr>
            <label for="dropsel">Choose Drop To</label>
      <select name="dropsel" id="dropsel"  onchange="selectChange(this.options[this.selectedIndex].value, 'drop')">
      <option value="">Select One</option>
      <option value="Forward Air">Forward Air</option>
      <option value="Land Air">Land Air</option>
      <option value="American Line Haul">American Line Haul</option>
      <option value="JIT">JIT</option>
      <option value="Act2">ACT2</option>
      <option value="Sterling">Sterling</option>
      <option value="Southwest">Southwest</option>
      <option value="American Airlines">American Airlines</option>
      <option value="Delta">Delta</option>
      <option value="United">United</option>
      </select>
      <br>
      <input type="text" id="drop" class="routeinp" value = "">
      <label for="dropbill" class="movable"> Drop Bill #</label>
      <input type="text" id="dropbill" class="routeinp" value = "">
      <hr>
      <button id="saveChanges" onClick= "saveRoutingChanges()" disabled >Save Any Changes</button>
        </div>
      </div>
    </div>
    <div id="divtab4" class="hidden">Cost Sheet

    </div>
  </div>


  <script>
        var tab1 = document.getElementById('tab1');
        var tab2 = document.getElementById('tab2');
        var tab3 = document.getElementById('tab3');
        var tab4 = document.getElementById('tab4');
        var divtab1 = document.getElementById('divtab1');
        var divtab2 = document.getElementById('divtab2');
        var divtab3 = document.getElementById('divtab3');
        var divtab4 = document.getElementById('divtab4');
        var hawbIn = document.getElementById('hawbIn');
        var qStr = "";
        var hawbSel = "";
        var dirty = false

        function saveRoutingChanges(){
        // code to save routing tab input info into spreadsheet
            console.log("SaveChanges")
            updateHawbvalues(function() {
                console.log(hawbSel)
                google.script.run.withSuccessHandler(onUpdateHawb1).updateSheet(hawbSel.hawb[0], hawbSel.rowIndex[0][0]);
         });
        }


        function askSave() {
          if(dirty == true){
          if (confirm('Save Changes?')) {
                console.log("SaveChanges")
                updateHawbvalues(function() {
                  console.log(hawbSel)
                  google.script.run.withSuccessHandler(onUpdateHawb1).updateSheet(hawbSel.hawb[0], hawbSel.rowIndex[0][0]);
                })
           } else {
              // Do nothing!
              console.log("DON'T SaveChanges")
           }
          // set dirty to false again after yes or no answer
          dirty = false
          }
        }

        function updateHawbvalues(callback) {
          //update the selected hawb value
          updateRoutingHawbSel(function(){
            callback()
          })
        }

        function onUpdateHawb1(){
          // set router button to disabled
          var buttonSave = document.getElementById("saveChanges");
          buttonSave.disabled = true;
          buttonSave.classList.remove("bigred")
          dirty = false
          //divtab3.innerHTML = ""
        }

        function tabClicked(tabClicked) {
            // show tab div on click
            switch(tabClicked) {
                case 1:
                    divtab1.classList.add('display');
                    divtab1.classList.remove('hidden');
                    divtab2.classList.add('hidden');
                    divtab3.classList.add('hidden');
                    divtab4.classList.add('hidden');
                    tab1.classList.add('selected');
                    tab2.classList.remove('selected');
                    tab3.classList.remove('selected');
                    tab4.classList.remove('selected');
                    break;
                case 2:
                    divtab1.classList.add('hidden');
                    divtab2.classList.add('display');
                    divtab2.classList.remove('hidden');
                    divtab3.classList.add('hidden');
                    divtab4.classList.add('hidden');
                    tab2.classList.add('selected');
                    tab1.classList.remove('selected');
                    tab3.classList.remove('selected');
                    tab4.classList.remove('selected');
                    break;
                case 3:
                    divtab1.classList.add('hidden');
                    divtab2.classList.add('hidden');
                    divtab3.classList.remove('hidden');
                    divtab3.classList.add('display');
                    divtab4.classList.add('hidden');
                    tab3.classList.add('selected');
                    tab1.classList.remove('selected');
                    tab2.classList.remove('selected');
                    tab4.classList.remove('selected');
                    // routing tab clicked fill in html code
                    //fillRoutingTab()
                    break;
                case 4:
                    divtab1.classList.add('hidden');
                    divtab2.classList.add('hidden');
                    divtab4.classList.remove('hidden');
                    divtab3.classList.add('hidden');
                    divtab4.classList.add('display');
                    tab4.classList.add('selected');
                    tab1.classList.remove('selected');
                    tab2.classList.remove('selected');
                    tab3.classList.remove('selected');
                    break;

            }
        }

        function checkForUpdate() {
        // run a function on code.gs to retrieve hawbs from spreadsheet and replace hawb in hawbgs onFocus
          google.script.run.withSuccessHandler(updateHawb).getHawbValues();
        }

        function updateHawb(jsonArr) {
          // use value returned and either replace hawb
          var hawb = JSON.parse(jsonArr)
          //console.log(hawb)
          hawbsgs.hawb = hawb;
        }

        function findHawb() {
          var input = document.getElementById('hawbIn').value;
          if(input.length > 3) {
            var hawbRtrn = matchHawb(input);
            var htmlTable = buildTable(hawbRtrn);
            var divtab1_2 = document.getElementById('divtab1_2')
            var divtab1 = document.getElementById('divtab1');
            divtab1_2.innerHTML = htmlTable;
          }
        }

        function matchHawb(hawb) {
          // match string in hawbsgs.hawb
          var hawbRowIndex= {}, hawbArr =[], rowIndex = [];
          for(i=1;i< hawbsgs.hawb.length; i++) {
           var stringVal = hawbsgs.hawb[i][3].toString().toUpperCase();
            if(stringVal.indexOf(hawb.toUpperCase()) != -1) {
             var index = stringVal.indexOf(hawb.toUpperCase())
             hawbArr.push(hawbsgs.hawb[i])
             rowIndex.push([i+1,i])
            }
           }
           hawbRowIndex= {hawb: hawbArr, rowIndex: rowIndex}
           return hawbRowIndex
        }

        function buildTable(hawbRowObj) {
        // check hawbRowObj.hawb.length <1 1st if yes put up enter new button
        if(hawbRowObj.hawb.length <1){
          var hawbTable = "<table><tr><th>Action</th></tr>"
          hawbTable += "<tr><td><button onClick= 'createNew()' >Create New</button></td></tr></table>"
        }else {
          // else build table from list of hawbs sent over
          var hawbTable = "<table><tr><th>(select)HAWB</th><th>Print</th><th>Update</th></tr>"
          for(x=0;x<hawbRowObj.hawb.length;x++) {
                    hawbTable += "<tr><td class='hawbrow fakelink' onClick= 'hawbSelected(this)'>" + hawbRowObj.hawb[x][3] + "</td><td onClick= 'printPost(" + hawbRowObj.rowIndex[x][0] + " )'><a><i class=" + '"fakelink fas fa-print"></i></a></td><td  onClick= "hawbUpdate(' + "'" + hawbRowObj.hawb[x][3].toString().toUpperCase() + "'" + ')"><i class="fakelink fas fa-edit"></i>'
                    hawbTable += "</td>"

          }
          hawbTable += "</table>"  ;
        }
          return hawbTable
        }

        function hawbUpdate(hawb) {
           //console.log(rowData.innerHTML.toString().toUpperCase())
           var hawbData = matchHawb(hawb.toUpperCase());
           var divtab1_2 = document.getElementById('divtab1_2')
           divtab1_2.innerHTML = "<h2>Opening Doc Now</h2>";
            // timer to clear Opening Doc Now
            setTimeout(function() {divtab1_2.innerHTML = "";}, 1500);
           // open model and send data command to code.gs
           google.script.run.withSuccessHandler(onSuccess).openHawbUpdate(hawbData);
         }

         function hawbSelected(tdData) {
           //console.log(rowData.innerHTML.toString().toUpperCase())
           hawbSel = matchHawb(tdData.innerHTML.toString().toUpperCase());
           var divtab1_2 = document.getElementById('divtab1_2') ;
           var hawbInput = document.getElementById('hawbIn');
           divtab1_2.innerHTML = "<h2>Opening Doc Now</h2>";

           updateRoutingHawbSel(function() {
              divtab1_2.innerHTML = "Active SELECTED HAWB: <h2><i>" + tdData.innerHTML.toString().toUpperCase() + "</i></h2>";
              hawbInput.value = "";
            });
         }

         function createNew() {
           var hawbEntry = document.getElementById('hawbIn').value
           var hawbData = {hawb: hawbEntry}
           // open hawbEntry.html to create a new HAWB into the spreadsheet
           google.script.run.withSuccessHandler(onSuccess).openHawbEntry(hawbData);
         }

        function onSuccess(result) {
          //function to handle success of updated ACI code Clear and reset sheet
          //console.log(result);
        }

        function selectChange(value, element) {
          document.getElementById(element).value = value;
        }
    </script>
    <!-- include the html file tabs which has js code in it for the tabs -->
    <?!= include('tabs'); ?>
    <?!= include('ajax'); ?>
</body>
</html>